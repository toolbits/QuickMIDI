#include <Folders.h>#define			ZeroValue				(long)0#define			ZeroPointer				(long)0#define			ZeroHandle				(long)0#define			PrefDlogID				128#define			FrontCGPort				(WindowPtr)-1L#define			ApplType				'QT+m'#define			PrefType				'Pref'#define			PrefFileName			"\pQuickMIDI Pref"#define			PrefResType				'Pref'#define			PrefResID				128typedef struct PrefSetting{	Boolean				AutoResetOn;	short				AutoResetSec;	Boolean				MultiDrumOn;	Boolean				OnlyUseStandardOn;	Boolean				LoadConnectionOn;		Boolean				WindowVisible;	Point				WindowPoint;} PrefSetting,*PrefSettingPtr,**PrefSettingHandle;//GlobalRoutinesvoid			PreferenceDialog		(void);Boolean			GetAutoResetOn			(void);short			GetAutoResetSec			(void);Boolean			GetMultiDrumOn			(void);Boolean			GetOnlyUseStandardOn	(void);Boolean			GetLoadConnectionOn		(void);void			SetWindowVisible		(Boolean);void			SetWindowPoint			(Point);Boolean			GetWindowVisible		(void);Point			GetWindowPoint			(void);void			LoadPreference			(void);void			SavePreference			(void);//ExternRoutinesextern	void	CopyStringByteX			(register unsigned char*,register unsigned char*);extern	short	GetApplResID			(void);extern	void	LoadPortConnection		(void);extern	void	SavePortConnection		(void);//StaticMemoriesstatic			PrefSetting				PrefMemory;static			Boolean					LoadPortSetting;void PreferenceDialog(void){		register		DialogPtr	DialogPort;	ControlHandle				ItemHandle;	short						ItemList;	Str255						String;	long						Number;	register		Boolean		Done;		Done = false;	if((DialogPort = GetNewDialog(PrefDlogID,ZeroPointer,FrontCGPort)) != ZeroPointer){		GetDialogItem(DialogPort,3,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);		SetControlValue(ItemHandle,PrefMemory.AutoResetOn);				GetDialogItem(DialogPort,4,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);		NumToString(PrefMemory.AutoResetSec,String);		SetDialogItemText((Handle)ItemHandle,String);				GetDialogItem(DialogPort,6,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);		SetControlValue(ItemHandle,PrefMemory.MultiDrumOn);				GetDialogItem(DialogPort,7,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);		SetControlValue(ItemHandle,PrefMemory.OnlyUseStandardOn);				GetDialogItem(DialogPort,8,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);		SetControlValue(ItemHandle,PrefMemory.LoadConnectionOn);		SetDialogDefaultItem(DialogPort,1);		SetDialogCancelItem(DialogPort,2);		SetDialogTracksCursor(DialogPort,true);		ShowWindow(DialogPort);				while(Done == false){			ModalDialog(ZeroPointer,&ItemList);			switch(ItemList){				case 1:				//Set					GetDialogItem(DialogPort,3,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);										PrefMemory.AutoResetOn = GetControlValue(ItemHandle);										GetDialogItem(DialogPort,4,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);					GetDialogItemText((Handle)ItemHandle,String);					StringToNum(String,&Number);					if(Number < 8) Number = 8;					if(Number > 999) Number = 999;					PrefMemory.AutoResetSec = Number;										GetDialogItem(DialogPort,6,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);					PrefMemory.MultiDrumOn = GetControlValue(ItemHandle);										GetDialogItem(DialogPort,7,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);					PrefMemory.OnlyUseStandardOn = GetControlValue(ItemHandle);					GetDialogItem(DialogPort,8,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);					PrefMemory.LoadConnectionOn = GetControlValue(ItemHandle);				case 2:				//Cancel					Done = true;					break;				case 3:				//Auto Reset Notes				case 6:				//Multi Drum Mode				case 7:				//Only Use Standard Drumkit				case 8:				//Save Port Connection					GetDialogItem(DialogPort,ItemList,ZeroPointer,(Handle*)&ItemHandle,ZeroPointer);					SetControlValue(ItemHandle,!GetControlValue(ItemHandle));					break;				default:					break;			}		}		HideWindow(DialogPort);		DisposeDialog(DialogPort);	}	SetCursor(&qd.arrow);	return;}/*PreferenceDialog*/Boolean GetAutoResetOn(void){	return(PrefMemory.AutoResetOn);}/*GetAutoResetOn*/short GetAutoResetSec(void){	return(PrefMemory.AutoResetSec);}/*GetAutoResetSec*/Boolean GetMultiDrumOn(void){	return(PrefMemory.MultiDrumOn);}/*GetMultiDrumOn*/Boolean GetOnlyUseStandardOn(void){	return(PrefMemory.OnlyUseStandardOn);}/*GetOnlyUseStandardOn*/Boolean GetLoadConnectionOn(void){	return(PrefMemory.LoadConnectionOn);}/*GetLoadConnectionOn*/void SetWindowVisible(Boolean Value){	PrefMemory.WindowVisible = Value;	return;}/*SetWindowVisible*/void SetWindowPoint(Point Value){	PrefMemory.WindowPoint = Value;	return;}/*SetWindowPoint*/Boolean GetWindowVisible(void){	return(PrefMemory.WindowVisible);}/*GetWindowVisible*/Point GetWindowPoint(void){	return(PrefMemory.WindowPoint);}/*GetWindowPoint*/void LoadPreference(void){	PrefSettingHandle	PrefHandle;	Handle				Rsrc;	FSSpec				PrefFile;	short				SerialID;	OSErr				ResultCode;		ResultCode = noErr;		PrefMemory.AutoResetOn = true;	PrefMemory.AutoResetSec = 8;	PrefMemory.MultiDrumOn = true;	PrefMemory.OnlyUseStandardOn = false;	PrefMemory.LoadConnectionOn = true;	PrefMemory.WindowVisible = true;	SetPt(&PrefMemory.WindowPoint,50,50);	if((ResultCode = FindFolder(kOnSystemDisk,kPreferencesFolderType,kCreateFolder,&(PrefFile.vRefNum),&(PrefFile.parID))) == noErr){		CopyStringByteX(PrefFileName,PrefFile.name);				if((SerialID = FSpOpenResFile(&PrefFile,fsRdWrPerm)) == -1){			FSpCreateResFile(&PrefFile,ApplType,PrefType,smSystemScript);			if((SerialID = FSpOpenResFile(&PrefFile,fsRdWrPerm)) == -1){				FSpDelete(&PrefFile);				ResultCode = !noErr;			}			else{				UseResFile(SerialID);				if((PrefHandle = (PrefSettingHandle)NewHandleClear(sizeof(PrefSetting))) != ZeroHandle){					if((Rsrc = NewHandleClear(0)) != ZeroHandle){												**PrefHandle = PrefMemory;											AddResource(Rsrc,PrefResType,PrefResID,"\p");						SetHandleSize(Rsrc,GetHandleSize((Handle)PrefHandle));						HLock(Rsrc);						HLock((Handle)PrefHandle);						BlockMove(*PrefHandle,*Rsrc,GetHandleSize((Handle)PrefHandle));						HUnlock((Handle)PrefHandle);						HUnlock(Rsrc);						ChangedResource(Rsrc);						WriteResource(Rsrc);						ReleaseResource(Rsrc);					}					else ResultCode = MemError();					DisposeHandle((Handle)PrefHandle);				}				else ResultCode = MemError();				if(ResultCode != noErr) CloseResFile(SerialID);				UseResFile(GetApplResID());			}		}				if(ResultCode == noErr){			UseResFile(SerialID);						if((PrefHandle = (PrefSettingHandle)NewHandleClear(sizeof(PrefSetting))) != ZeroHandle){				if((Rsrc = Get1Resource(PrefResType,PrefResID)) != ZeroHandle){					DetachResource(Rsrc);					if(GetHandleSize(Rsrc) == GetHandleSize((Handle)PrefHandle)){						HLock((Handle)PrefHandle);						HLock(Rsrc);						BlockMove(*Rsrc,*PrefHandle,GetHandleSize((Handle)PrefHandle));						HUnlock(Rsrc);						HUnlock((Handle)PrefHandle);						PrefMemory = **PrefHandle;					}					DisposeHandle(Rsrc);				}				DisposeHandle((Handle)PrefHandle);			}						if(PrefMemory.LoadConnectionOn == true) LoadPortConnection();						UseResFile(GetApplResID());			CloseResFile(SerialID);		}				FlushVol(ZeroPointer,PrefFile.vRefNum);	}	LoadPortSetting = PrefMemory.LoadConnectionOn;	return;}/*LoadPreference*/void SavePreference(void){	PrefSettingHandle	PrefHandle;	Handle				Rsrc;	FSSpec				PrefFile;	short				SerialID;	OSErr				ResultCode;		ResultCode = noErr;	if((ResultCode = FindFolder(kOnSystemDisk,kPreferencesFolderType,kCreateFolder,&(PrefFile.vRefNum),&(PrefFile.parID))) == noErr){		CopyStringByteX(PrefFileName,PrefFile.name);				if((SerialID = FSpOpenResFile(&PrefFile,fsRdWrPerm)) == -1){			FSpCreateResFile(&PrefFile,ApplType,PrefType,smSystemScript);			if((SerialID = FSpOpenResFile(&PrefFile,fsRdWrPerm)) == -1){				FSpDelete(&PrefFile);				ResultCode = !noErr;			}		}		if(ResultCode == noErr){			UseResFile(SerialID);						if((PrefHandle = (PrefSettingHandle)NewHandleClear(sizeof(PrefSetting))) != ZeroHandle){				**PrefHandle = PrefMemory;								if((Rsrc = Get1Resource(PrefResType,PrefResID)) == ZeroHandle){					Rsrc = NewHandleClear(0);					AddResource(Rsrc,PrefResType,PrefResID,"\p");				}				SetHandleSize(Rsrc,GetHandleSize((Handle)PrefHandle));				HLock(Rsrc);				HLock((Handle)PrefHandle);				BlockMove(*PrefHandle,*Rsrc,GetHandleSize((Handle)PrefHandle));				HUnlock((Handle)PrefHandle);				HUnlock(Rsrc);							ChangedResource(Rsrc);				WriteResource(Rsrc);				ReleaseResource(Rsrc);				DisposeHandle((Handle)PrefHandle);			}						if(LoadPortSetting == true) SavePortConnection();						UseResFile(GetApplResID());			CloseResFile(SerialID);		}		FlushVol(ZeroPointer,PrefFile.vRefNum);	}	return;}/*SavePreference*/