#include <QDOffscreen.h>#define			ZeroValue				(long)0#define			ZeroPointer				(long)0#define			ZeroHandle				(long)0#define			MainGraphicID			128#define			AboutGraphicID			129#define			DisplayMach				(long)8#define			AboutMessageDelay		5typedef struct RGBGWorldStruct{	CGrafPtr				SaveGPort;	RGBColor				SaveForeRGB;	RGBColor				SaveBackRGB;} RGBGWorldStruct,*RGBGWorldPtr,**RGBGWorldHandle;//GlobalRoutinesOSErr				SetupGWorld				(void);void				ResetGWorld				(void);void				VisualMainGraphic		(void);void				DrawLevelBar			(register short[16]);void				DrawAboutMessage		(register short[16]);//StaticRoutinesstatic	void		RememberGWorld			(void);static	void		RestoreGWorld			(void);static	void		SetRGBColor				(register RGBColor*,register unsigned short,register unsigned short,register unsigned short);//ExternRoutinesCWindowPtr			GetMainWindow			(void);//StaticMemoriesstatic				GWorldPtr				GWorldGraf;static				GWorldPtr				GWorldAbout;static				RGBGWorldStruct			SaveRGBGWorld;static				short					SaveData[16] = {0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF};static				short					SaveDataMes[16] = {0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF};//ExternMemoriesextern				Boolean					AboutMessageOn;extern				Boolean					AutoAboutHide;OSErr SetupGWorld(void){	CGrafPtr					SaveGPort;	GDHandle					SaveGDevice;	GWorldPtr					SaveGWorld;	register	PixMapHandle	GraphicPixMap;	register	PicHandle		Graphic;	OSErr						Result;	Result = noErr;	GetPort((GrafPtr*)&SaveGPort);	GetGWorld(&SaveGWorld,&SaveGDevice);	if((Graphic = GetPicture(MainGraphicID)) != ZeroHandle){		DetachResource((Handle)Graphic);		if((Result = NewGWorld(&GWorldGraf,DisplayMach,&((*Graphic)->picFrame),ZeroHandle,ZeroHandle,ZeroValue)) == noErr){			GraphicPixMap = GetGWorldPixMap(GWorldGraf);			NoPurgePixels(GraphicPixMap);			LockPixels(GraphicPixMap);			SetGWorld(GWorldGraf,ZeroHandle);			PenNormal();			DrawPicture(Graphic,&((*Graphic)->picFrame));		}		KillPicture(Graphic);	}	else Result = ResError();		if(Result == noErr){		if((Graphic = GetPicture(AboutGraphicID)) != ZeroHandle){			DetachResource((Handle)Graphic);			if((Result = NewGWorld(&GWorldAbout,DisplayMach,&((*Graphic)->picFrame),ZeroHandle,ZeroHandle,ZeroValue)) == noErr){				GraphicPixMap = GetGWorldPixMap(GWorldAbout);				NoPurgePixels(GraphicPixMap);				LockPixels(GraphicPixMap);				SetGWorld(GWorldAbout,ZeroHandle);				PenNormal();				DrawPicture(Graphic,&((*Graphic)->picFrame));			}			KillPicture(Graphic);		}		else Result = ResError();	}	SetGWorld(SaveGWorld,SaveGDevice);	SetPort((GrafPtr)SaveGPort);	return(Result);}/*SetupGWorld*/void ResetGWorld(void){	register	PixMapHandle	GraphicPixMap;	GraphicPixMap = GetGWorldPixMap(GWorldGraf);	UnlockPixels(GraphicPixMap);	AllowPurgePixels(GraphicPixMap);	DisposeGWorld(GWorldGraf);	return;}/*ResetGWorld*/void VisualMainGraphic(void){	register	PixMapHandle	PanelPixMap;	Rect						RectMP;	RememberGWorld();	SetRect(&RectMP,0,0,200,60);	PanelPixMap = GetGWorldPixMap(GWorldGraf);	CopyBits((BitMap*)*PanelPixMap,(BitMap*)*(GetMainWindow()->portPixMap),&RectMP,&RectMP,srcCopy,ZeroHandle);	RestoreGWorld();	return;}/*VisualMainGraphic*/static void RememberGWorld(void){	RGBColor					NewForeRGB;	RGBColor					NewBackRGB;	GetPort((GrafPtr*)&(SaveRGBGWorld.SaveGPort));	SetPort((GrafPtr)GetMainWindow());	GetForeColor(&(SaveRGBGWorld.SaveForeRGB));	GetBackColor(&(SaveRGBGWorld.SaveBackRGB));	SetRGBColor(&NewForeRGB,0x0000,0x0000,0x0000);	SetRGBColor(&NewBackRGB,0xFFFF,0xFFFF,0xFFFF);	RGBForeColor(&NewForeRGB);	RGBBackColor(&NewBackRGB);	return;}/*RememberGWorld*/static void RestoreGWorld(void){	RGBForeColor(&(SaveRGBGWorld.SaveForeRGB));	RGBBackColor(&(SaveRGBGWorld.SaveBackRGB));	SetPort((GrafPtr)SaveRGBGWorld.SaveGPort);	return;}/*RestoreGWorld*/static void SetRGBColor(register RGBColor *ColorObject,register unsigned short Red,register unsigned short Green,register unsigned short Blue){	ColorObject->red = Red;	ColorObject->green = Green;	ColorObject->blue = Blue;	return;}/*SetRGBColor*/void DrawLevelBar(register short Data[16]){	register	PixMapHandle	PanelPixMap;	Rect						RectDet;	Rect						RectOne;	register	short			ID;	RememberGWorld();	PanelPixMap = GetGWorldPixMap(GWorldGraf);	SetRect(&RectOne,3,63,13,100);	SetRect(&RectDet,32,8,42,45);		for(ID=0;ID<16;ID++){		if(Data[ID] != SaveData[ID]){			SaveData[ID] = Data[ID];			RectOne.left = Data[ID] * 10 + 3;			RectOne.right = Data[ID] * 10 + 13;						CopyBits((BitMap*)*PanelPixMap,(BitMap*)*PanelPixMap,&RectOne,&RectDet,srcCopy,ZeroHandle);			CopyBits((BitMap*)*PanelPixMap,(BitMap*)*(GetMainWindow()->portPixMap),&RectOne,&RectDet,srcCopy,ZeroHandle);		}		RectDet.left += 10;		RectDet.right += 10;	}	RestoreGWorld();	return;}/*DrawLevelBar*/void DrawAboutMessage(register short Data[16]){	register	PixMapHandle	PanelPixMap;	register	PixMapHandle	AboutPixMap;	Rect						RectMP;	Rect						RectCM;	Rect						RectDetOne;	Rect						RectDetTwo;		Rect						RectOne;	static		short			Status = 0;	static		short			Delay = 0;	register	short			ID;		RememberGWorld();	PanelPixMap = GetGWorldPixMap(GWorldGraf);	AboutPixMap = GetGWorldPixMap(GWorldAbout);		SetRect(&RectOne,3,63,13,100);	SetRect(&RectDetOne,2,2,12,39);		SetRect(&RectDetTwo,2,166,12,203);		for(ID=0;ID<16;ID++){		if(Data[ID] != SaveDataMes[ID]){			SaveDataMes[ID] = Data[ID];			RectOne.left = Data[ID] * 10 + 3;			RectOne.right = Data[ID] * 10 + 13;						CopyBits((BitMap*)*PanelPixMap,(BitMap*)*AboutPixMap,&RectOne,&RectDetOne,srcCopy,ZeroHandle);			CopyBits((BitMap*)*PanelPixMap,(BitMap*)*AboutPixMap,&RectOne,&RectDetTwo,srcCopy,ZeroHandle);		}		RectDetOne.left += 10;		RectDetOne.right += 10;		RectDetTwo.left += 10;		RectDetTwo.right += 10;	}		SetRect(&RectMP,30,6,193,47);	SetRect(&RectCM,0,Status,163,Status + 41);	CopyBits((BitMap*)*AboutPixMap,(BitMap*)*PanelPixMap,&RectCM,&RectMP,srcCopy,ZeroHandle);	CopyBits((BitMap*)*AboutPixMap,(BitMap*)*(GetMainWindow()->portPixMap),&RectCM,&RectMP,srcCopy,ZeroHandle);	RestoreGWorld();		Delay++;	if(Delay > AboutMessageDelay){		Status++;		if(Status > 164){			if(AutoAboutHide == true) HideWindow((WindowPtr)GetMainWindow());			AboutMessageOn = false;			Status = 0;			for(ID=0;ID<16;ID++){				SaveData[ID] = 0xFFFF;				SaveDataMes[ID] = 0xFFFF;			}			DrawLevelBar(Data);		}		Delay = 0;	}	return;}/*DrawAboutMessage*/